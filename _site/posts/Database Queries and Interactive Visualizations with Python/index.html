<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Haoran Jia">
<meta name="dcterms.date" content="2023-10-22">

<title>myblog - Database Queries and Interactive Visualizations with Python</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">myblog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page">
      <h1 class="title">Database Queries and Interactive Visualizations with Python</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Haoran Jia </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 22, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block column-page" id="quarto-document-content">




<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://images.prismic.io/plotly-marketing-website-2/24f8da7c-f17b-4418-9d07-85d9287d8194_timeline_assets-02.png?auto=compress,format" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Source: https://plotly.com/about-us/</figcaption>
</figure>
</div>
<p>In this tutorial, weâ€™ll work with <code>sqlite3</code>, <code>plotly</code>, and <code>pandas</code> on a climate dataset. By the end, you should be comfortable with creating a SQLite database using Python, querying with SQL, and crafting customized graphs with Plotly.</p>
<p><strong>Note:</strong> For the successful rendering of the interactive plots, run the following.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:18510,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018126406,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-outputid="c553caed-88fc-4873-df7c-21df8a3fb4c0" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.io <span class="im">as</span> pio</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>pio.renderers.default<span class="op">=</span><span class="st">"iframe"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="data-import" class="level3">
<h3 class="anchored" data-anchor-id="data-import">Data Import</h3>
<p>First, we need to read in three required tables with <code>pandas</code>, and then we will be creating a database based on these tables.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:11509,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018137913,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Read from files</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>stations <span class="op">=</span> pd.read_csv(<span class="st">"station-metadata.csv"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>temps <span class="op">=</span> pd.read_csv(<span class="st">'temps_stacked.csv'</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>countries <span class="op">=</span> pd.read_csv(<span class="st">'countries.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Letâ€™s take a look at each dataset.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:11,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018137914,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-outputid="5483f783-5a4d-4b62-ab22-5f368530f1ed" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>stations.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ID</th>
<th data-quarto-table-cell-role="th">LATITUDE</th>
<th data-quarto-table-cell-role="th">LONGITUDE</th>
<th data-quarto-table-cell-role="th">STNELEV</th>
<th data-quarto-table-cell-role="th">NAME</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>ACW00011604</td>
<td>57.7667</td>
<td>11.8667</td>
<td>18.0</td>
<td>SAVE</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>AE000041196</td>
<td>25.3330</td>
<td>55.5170</td>
<td>34.0</td>
<td>SHARJAH_INTER_AIRP</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>AEM00041184</td>
<td>25.6170</td>
<td>55.9330</td>
<td>31.0</td>
<td>RAS_AL_KHAIMAH_INTE</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>AEM00041194</td>
<td>25.2550</td>
<td>55.3640</td>
<td>10.4</td>
<td>DUBAI_INTL</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>AEM00041216</td>
<td>24.4300</td>
<td>54.4700</td>
<td>3.0</td>
<td>ABU_DHABI_BATEEN_AIR</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:9,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018137914,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-outputid="fb2e7a9a-930c-4354-90ee-de7f07a370cc" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>temps.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ID</th>
<th data-quarto-table-cell-role="th">Year</th>
<th data-quarto-table-cell-role="th">Month</th>
<th data-quarto-table-cell-role="th">Temp</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>ACW00011604</td>
<td>1961</td>
<td>1</td>
<td>-0.89</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>ACW00011604</td>
<td>1961</td>
<td>2</td>
<td>2.36</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>ACW00011604</td>
<td>1961</td>
<td>3</td>
<td>4.72</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>ACW00011604</td>
<td>1961</td>
<td>4</td>
<td>7.73</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>ACW00011604</td>
<td>1961</td>
<td>5</td>
<td>11.28</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:8,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018137914,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-outputid="6add6ff2-c74d-4ebb-b89e-34853ec6bc55" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>countries.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">FIPS 10-4</th>
<th data-quarto-table-cell-role="th">ISO 3166</th>
<th data-quarto-table-cell-role="th">Name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>AF</td>
<td>AF</td>
<td>Afghanistan</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>AX</td>
<td>-</td>
<td>Akrotiri</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>AL</td>
<td>AL</td>
<td>Albania</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>AG</td>
<td>DZ</td>
<td>Algeria</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>AQ</td>
<td>AS</td>
<td>American Samoa</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Notice that there is no country names in <code>stations</code>. We may want to add an extra column named country to it for future convenience. We can do this by merging <code>stations</code> and <code>countries</code> using the two-letter ID. As a good practice, all operations with dataframe will be enclosed in a function.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:215,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018138122,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_df(stations):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Prepare the stations DataFrame by merging it with the countries DataFrame and renaming columns.</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">    This function extracts the 'FIPS 10-4' code from the 'ID' column of the stations DataFrame,</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">    merges the stations DataFrame with the countries DataFrame based on the 'FIPS 10-4' code,</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">    drops unnecessary columns, and renames the 'Name' column to 'Country'.</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">    - stations (pd.DataFrame): The stations dataset.</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">    - pd.DataFrame: A modified version of the stations DataFrame after merging and renaming operations.</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the 'FIPS 10-4' code from the 'ID' column</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    stations[<span class="st">'FIPS 10-4'</span>] <span class="op">=</span> stations[<span class="st">'ID'</span>].<span class="bu">str</span>[:<span class="dv">2</span>]</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge the stations DataFrame with the countries DataFrame based on the 'FIPS 10-4' code</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    stations <span class="op">=</span> pd.merge(stations, countries, on<span class="op">=</span><span class="st">'FIPS 10-4'</span>)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop unnecessary columns</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    stations <span class="op">=</span> stations.drop([<span class="st">'FIPS 10-4'</span>, <span class="st">'ISO 3166'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rename the 'Name' column to 'Country'</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    stations.rename(columns<span class="op">=</span>{<span class="st">'Name'</span>: <span class="st">'Country'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> stations</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>stations <span class="op">=</span> prepare_df(stations)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="creating-databases" class="level3">
<h3 class="anchored" data-anchor-id="creating-databases">Creating Databases</h3>
<p>In this section, we are going to create a database with three tables we have: <code>temperatures</code>, <code>stations</code>, and <code>countries</code>.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:2,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018138122,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create database</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>conn <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">"temps.db"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We observe that <code>temps</code> is extremely large, so we may want to add it to the database by chunks.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:39971,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018178091,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read segmented table into database</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>df_iter <span class="op">=</span> pd.read_csv(<span class="st">'temps_stacked.csv'</span>, chunksize <span class="op">=</span> <span class="dv">100000</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> df <span class="kw">in</span> df_iter:</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    df.to_sql(<span class="st">"temperatures"</span>, conn, if_exists <span class="op">=</span> <span class="st">"append"</span>, index <span class="op">=</span> <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Add other two datasets to the database.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:509,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018178572,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-outputid="0e7e0997-4d42-4fad-bc80-0fec53e62ad8" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read other two tables into database</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>stations.to_sql(<span class="st">"stations"</span>, conn, if_exists <span class="op">=</span> <span class="st">"replace"</span>, index <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>countries.to_sql(<span class="st">"countries"</span>, conn, if_exists <span class="op">=</span> <span class="st">"replace"</span>, index <span class="op">=</span> <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>279</code></pre>
</div>
</div>
<p>Always remember to close the dataset connection when you are not using.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:7,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018178572,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>conn.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="a-simple-query-function" class="level3">
<h3 class="anchored" data-anchor-id="a-simple-query-function">A simple Query Function</h3>
<p>Connect to the database before using, and then create a cursor to interact with it.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:5,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018178572,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># connect to database</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>conn <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">"temps.db"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Letâ€™s first check all three tables are in the database.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:5,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018178572,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-outputid="66d71d60-2d40-4338-846c-dc6424caaab0" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a cursor object to interact with the SQLite database</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>cursor <span class="op">=</span> conn.cursor()</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Execute an SQL query to fetch the names of all tables in the database</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>cursor.execute(<span class="st">"SELECT name FROM sqlite_master WHERE type='table'"</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the names of the tables</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cursor.fetchall())</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Close the database connection</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>conn.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[('temperatures',), ('stations',), ('countries',)]</code></pre>
</div>
</div>
<p>With the data, we can start to ask our first question: <strong><em>how does the average yearly change in temperature vary within a given country?</em></strong></p>
<p>We may create a map scatter plot where color of dots will represent temperature. But before doing that, we may want to retrieve necessary data frist.</p>
<blockquote class="blockquote">
<p>We are going to do this with a query function called <code>query_climate_database</code> which accepts four arguments:</p>
</blockquote>
<ul>
<li><code>country</code>, a string giving the name of a country for which data should be returned.</li>
<li><code>year_begin</code> and <code>year_end</code>, two integers giving the earliest and latest years for which should be returned.</li>
<li><code>month</code>, an integer giving the month of the year for which should be returned.</li>
</ul>
<p>The return value is a Pandas dataframe of temperature readings for the specified country, in the specified date range, in the specified month of the year.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:234,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018178802,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> query_climate_database(country, year_begin, year_end, month):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Fetch climate data for a specified country, year range, and month from an SQLite database.</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">    This function queries temperature data based on a specified country, year range, and month</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">    from an SQLite database and returns the data as a pandas DataFrame.</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">    - country (str): The name of the country for which data is to be fetched.</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">    - year_begin (int): The starting year for the data range.</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co">    - year_end (int): The ending year for the data range.</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co">    - month (int): The month for which data is to be fetched.</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co">    - pd.DataFrame: A DataFrame containing temperature data for the specified country, year range, and month.</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Example:</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; df = query_climate_database('India', 2000, 2020, 1)</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="co">    Fetches temperature data for India for the month of January between the years 2000 and 2020.</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Connect to the SQLite database</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    conn <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">"temps.db"</span>)</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    cursor <span class="op">=</span> conn.cursor()</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Execute the SQL query to fetch temperature data</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    cursor.execute(<span class="ss">f"SELECT s.NAME, s.LATITUDE, s.LONGITUDE, s.Country, t.Year, t.Month, t.Temp </span><span class="ch">\</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="ss">                     FROM temperatures t JOIN stations s ON s.ID = t.ID </span><span class="ch">\</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="ss">                     WHERE s.Country = '</span><span class="sc">{</span>country<span class="sc">}</span><span class="ss">' AND Year &gt;= </span><span class="sc">{</span>year_begin<span class="sc">}</span><span class="ss"> AND Year &lt;= </span><span class="sc">{</span>year_end<span class="sc">}</span><span class="ss"> AND t.Month = </span><span class="sc">{</span>month<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert the fetched data to a pandas DataFrame</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    result_df <span class="op">=</span> pd.DataFrame(cursor.fetchall(), columns<span class="op">=</span>[<span class="st">'Name'</span>, <span class="st">'Latitude'</span>, <span class="st">'Longitude'</span>,</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>                                                         <span class="st">'Country'</span>, <span class="st">'Year'</span>, <span class="st">'Month'</span>, <span class="st">'Temp'</span>])</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Close the database connection</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    conn.close()</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Letâ€™s see an example usage.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:3394,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018182193,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-outputid="985a7e75-2aa4-412c-ed6b-d9a177750a73" data-execution_count="14">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example output</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>query_climate_database(country <span class="op">=</span> <span class="st">"India"</span>,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                       year_begin <span class="op">=</span> <span class="dv">1980</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                       year_end <span class="op">=</span> <span class="dv">2020</span>,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>                       month <span class="op">=</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Name</th>
<th data-quarto-table-cell-role="th">Latitude</th>
<th data-quarto-table-cell-role="th">Longitude</th>
<th data-quarto-table-cell-role="th">Country</th>
<th data-quarto-table-cell-role="th">Year</th>
<th data-quarto-table-cell-role="th">Month</th>
<th data-quarto-table-cell-role="th">Temp</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>PBO_ANANTAPUR</td>
<td>14.583</td>
<td>77.633</td>
<td>India</td>
<td>1980</td>
<td>1</td>
<td>23.48</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>PBO_ANANTAPUR</td>
<td>14.583</td>
<td>77.633</td>
<td>India</td>
<td>1980</td>
<td>1</td>
<td>23.48</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>PBO_ANANTAPUR</td>
<td>14.583</td>
<td>77.633</td>
<td>India</td>
<td>1980</td>
<td>1</td>
<td>23.48</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>PBO_ANANTAPUR</td>
<td>14.583</td>
<td>77.633</td>
<td>India</td>
<td>1980</td>
<td>1</td>
<td>23.48</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>PBO_ANANTAPUR</td>
<td>14.583</td>
<td>77.633</td>
<td>India</td>
<td>1981</td>
<td>1</td>
<td>24.57</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12603</td>
<td>DARJEELING</td>
<td>27.050</td>
<td>88.270</td>
<td>India</td>
<td>1995</td>
<td>1</td>
<td>5.60</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12604</td>
<td>DARJEELING</td>
<td>27.050</td>
<td>88.270</td>
<td>India</td>
<td>1997</td>
<td>1</td>
<td>5.70</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12605</td>
<td>DARJEELING</td>
<td>27.050</td>
<td>88.270</td>
<td>India</td>
<td>1997</td>
<td>1</td>
<td>5.70</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12606</td>
<td>DARJEELING</td>
<td>27.050</td>
<td>88.270</td>
<td>India</td>
<td>1997</td>
<td>1</td>
<td>5.70</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12607</td>
<td>DARJEELING</td>
<td>27.050</td>
<td>88.270</td>
<td>India</td>
<td>1997</td>
<td>1</td>
<td>5.70</td>
</tr>
</tbody>
</table>

<p>12608 rows Ã— 7 columns</p>
</div>
</div>
</div>
</section>
<section id="visualization-1-geographic-scatter-plot-for-yearly-temperature-increases" class="level3">
<h3 class="anchored" data-anchor-id="visualization-1-geographic-scatter-plot-for-yearly-temperature-increases">Visualization 1: Geographic Scatter Plot for Yearly Temperature Increases</h3>
<p>Before moving, letâ€™s first compute a simple estimate of the <strong>year-over-year average change in temperature</strong> in each month at each station to add more fun. For this, weâ€™ll use our old friend, linear regression. Weâ€™ll use the statistical fact that, when regressing <code>Temp</code> against <code>Year</code>, the coefficient of <code>Year</code> will be an estimate of the yearly change in <code>Temp</code>.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1419,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018183607,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> coef(data_group):</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate the coefficient of the linear regression model for temperature against year.</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">    This function fits a linear regression model using the "Year" as the independent variable</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">    and "Temp" as the dependent variable. It returns the coefficient of the "Year",</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co">    which represents the rate of change of temperature with respect to the year.</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co">    - data_group: A pandas grouped object.</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">    - float: The coefficient of the "Year" in the linear regression model.</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract x and y variables from data group</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> data_group[[<span class="st">"Year"</span>]]</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> data_group[<span class="st">"Temp"</span>]</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize and fit the linear regression model</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    LR <span class="op">=</span> LinearRegression()</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    LR.fit(x, y)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the coefficient of the "Year"</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> LR.coef_[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we are going to write a function called <code>temperature_coefficient_plot</code> to visualize the data we fetched from the database. This function will accept five explicit arguments, and an undetermined number of keyword arguments.</p>
<blockquote class="blockquote">
<p><code>country</code>, <code>year_begin</code>, <code>year_end</code>, and <code>month</code> are as in the previous part. <code>min_obs</code>, the minimum required number of years of data for any given station. Only data for stations with at least <code>min_obs</code> years worth of data in the specified month would be plotted; the others would be filtered out. We will use <code>df.transform()</code> plus filtering to achieve this task. <code>**kwargs</code> is an additional keyword arguments passed to <code>px.scatter_mapbox()</code>. These can be used to control the colormap used, the mapbox style, etc.</p>
</blockquote>
<p>The output of this function would be an interactive geographic scatterplot, constructed using Plotly Express, with a point for each station, such that the color of the point reflects an estimate of the yearly change in temperature during the specified month and time period at that station.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:693,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018184297,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotly <span class="im">import</span> express <span class="im">as</span> px</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a color map for the plot</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>color_map <span class="op">=</span> px.colors.diverging.RdGy_r</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a mapping for creating titles</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>month_mapping <span class="op">=</span> {</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>: <span class="st">"January"</span>,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span>: <span class="st">"February"</span>,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="dv">3</span>: <span class="st">"March"</span>,</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="dv">4</span>: <span class="st">"April"</span>,</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="dv">5</span>: <span class="st">"May"</span>,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="dv">6</span>: <span class="st">"June"</span>,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="dv">7</span>: <span class="st">"July"</span>,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="dv">8</span>: <span class="st">"August"</span>,</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="dv">9</span>: <span class="st">"September"</span>,</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span>: <span class="st">"October"</span>,</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="dv">11</span>: <span class="st">"November"</span>,</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="dv">12</span>: <span class="st">"December"</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> temperature_coefficient_plot(country, year_begin, year_end, month, min_obs, <span class="op">**</span>kwargs):</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate a scatter map plot showing the estimated yearly increase in temperature for various stations.</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="co">    This function queries temperature data for a specified country, month, and year range.</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="co">    It then calculates the coefficient of the linear regression model for temperature against year</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="co">    for each station and plots the stations on a map. The color of each station represents the</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="co">    estimated yearly increase in temperature.</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="co">    - country (str): The name of the country for which the plot is to be generated.</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="co">    - year_begin (int): The starting year for the data range.</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="co">    - year_end (int): The ending year for the data range.</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="co">    - month (int): The month for which the plot is to be generated.</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a><span class="co">    - min_obs (int): Minimum number of observations required for a station to be included in the plot.</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a><span class="co">    - **kwargs: Additional keyword arguments for the plotly express scatter_mapbox function.</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a><span class="co">    - plotly.graph_objs._figure.Figure: A Plotly figure object representing the scatter map plot.</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a><span class="co">    Example:</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; fig = temperature_coefficient_plot("India", 1980, 2020, 1, min_obs=10, zoom=3, center={'lat':23,'lon':80})</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a><span class="co">    Generates a scatter map plot for India for the month of January between the years 1980 and 2020.</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Query the climate database for the specified parameters</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>    temp_df <span class="op">=</span> query_climate_database(country, year_begin, year_end, month)</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter stations based on the minimum number of observations</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>    temp_df[<span class="st">'min_obs'</span>] <span class="op">=</span> temp_df.groupby(<span class="st">'Name'</span>)[<span class="st">'Year'</span>].transform(<span class="st">'nunique'</span>)</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>    temp_df <span class="op">=</span> temp_df[temp_df[<span class="st">'min_obs'</span>] <span class="op">&gt;=</span> min_obs]</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the coefficient for each station and merge it into the main dataframe</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>    coefs <span class="op">=</span> temp_df.groupby([<span class="st">"Name"</span>]).<span class="bu">apply</span>(coef)</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>    coefs <span class="op">=</span> coefs.reset_index()</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>    temp_df <span class="op">=</span> pd.merge(temp_df, coefs, on<span class="op">=</span><span class="st">'Name'</span>)</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>    temp_df.rename(columns<span class="op">=</span>{<span class="dv">0</span>: <span class="st">'Estimate'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>    temp_df[<span class="st">'Estimate'</span>] <span class="op">=</span> temp_df[<span class="st">'Estimate'</span>].<span class="bu">round</span>(<span class="dv">4</span>)  <span class="co"># Round the estimates for better visualization</span></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>    max_abs_estimate <span class="op">=</span> temp_df[<span class="st">'Estimate'</span>].<span class="bu">abs</span>().<span class="bu">max</span>()  <span class="co"># Determine the maximum absolute estimate for color scaling</span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create the scatter map plot using plotly express</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> px.scatter_mapbox(temp_df,</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>                            hover_name<span class="op">=</span><span class="st">"Name"</span>,</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>                            lat<span class="op">=</span><span class="st">"Latitude"</span>,</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>                            lon<span class="op">=</span><span class="st">"Longitude"</span>,</span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>                            color<span class="op">=</span><span class="st">'Estimate'</span>,</span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>                            range_color<span class="op">=</span>[<span class="op">-</span>max_abs_estimate, max_abs_estimate],</span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>                            <span class="op">**</span>kwargs)</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update the layout and title of the plot</span></span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>    fig.update_layout(title_text<span class="op">=</span><span class="ss">f"""Estimate of yearly increase in temperature in </span><span class="sc">{</span>month_mapping[month]<span class="sc">}</span><span class="ss"> for stations in </span><span class="sc">{</span>country<span class="sc">}</span><span class="ss">, between </span><span class="sc">{</span>year_begin<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>year_end<span class="sc">}</span><span class="ss">"""</span>)</span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Letâ€™s try generating a scatter map plot of temperature for India in January between the years 1980 and 2020.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:3547,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018187842,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-outputid="279085d1-08f9-4d16-c21c-77d70c97f6d6" data-execution_count="17">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage: Generate and display the plot for India</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> temperature_coefficient_plot(<span class="st">"India"</span>, <span class="dv">1980</span>, <span class="dv">2020</span>, <span class="dv">1</span>, min_obs<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                                  zoom<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                                  center<span class="op">=</span>{<span class="st">'lat'</span>:<span class="dv">23</span>,<span class="st">'lon'</span>:<span class="dv">80</span>},</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                                  mapbox_style<span class="op">=</span><span class="st">"carto-positron"</span>,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>                                  color_continuous_scale<span class="op">=</span>color_map)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="100%" height="545px" src="iframe_figures/figure_17.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
<p>From this graph we can see that the estimate in temperature increase mostly appears near the border lines of India, while inland temperature is expected to drop.</p>
<p>To generalize the fucntion, letâ€™s test with an another example.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:2513,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018190345,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-outputid="ae2a2c52-68b2-4018-d6fc-e08fa04a8a68" data-execution_count="18">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> temperature_coefficient_plot(<span class="st">"China"</span>, <span class="dv">1960</span>, <span class="dv">1980</span>, <span class="dv">10</span>, min_obs <span class="op">=</span> <span class="dv">10</span>,</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>                                  zoom <span class="op">=</span> <span class="fl">2.5</span>,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                                  center <span class="op">=</span> {<span class="st">'lat'</span>:<span class="dv">40</span>,<span class="st">'lon'</span>:<span class="dv">110</span>},</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                                  mapbox_style<span class="op">=</span><span class="st">"carto-positron"</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                                  color_continuous_scale<span class="op">=</span>color_map)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="100%" height="545px" src="iframe_figures/figure_18.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
<p>The graphs shows that the stations mostly centered at the South Eastern side of China, while the largest estimate in temperature increase appears in far North and West.</p>
</section>
<section id="visualization-2-line-plot-for-yearly-and-monthly-average-temperature-change" class="level3">
<h3 class="anchored" data-anchor-id="visualization-2-line-plot-for-yearly-and-monthly-average-temperature-change">Visualization 2: Line Plot for Yearly and Monthly Average Temperature Change</h3>
<p>In this section, we want to ask: <strong><em>how does the average temperature in certain country changes over time?</em></strong></p>
<p>To answer this question, we may create a line plot where x axis is date and y axis is the average temperature.</p>
<blockquote class="blockquote">
<p>Again, we are going to start with a query function called <code>query_avg_temp_by_country</code> which accepts three arguments: <code>country</code>, <code>year_begin</code>, and <code>year_end</code> as in the previous part.</p>
</blockquote>
<p>The return value is a Pandas dataframe of temperature readings for the specified country, in the specified date range, in the specified month of the year.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:9,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018190345,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> query_avg_temp_by_country(country, year_begin<span class="op">=</span><span class="dv">1901</span>, year_end<span class="op">=</span><span class="dv">2020</span>):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Fetch average temperature data for a specified country from an SQLite database.</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">    This function queries temperature data based on a specified country and a year range</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">    from an SQLite database and returns the data as a pandas DataFrame.</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co">    - country (str): The name of the country for which data is to be fetched.</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">    - year_begin (int, optional): The starting year for the data range. Default is 1901.</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co">    - year_end (int, optional): The ending year for the data range. Default is 2020.</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co">    - pd.DataFrame: A DataFrame containing temperature data for the specified country and year range.</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Example:</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; df = query_avg_temp_by_country('India', year_begin=2000, year_end=2010)</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Fetches temperature data for India between the years 2000 and 2010.</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Connect to the SQLite database</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    conn <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">"temps.db"</span>)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    cursor <span class="op">=</span> conn.cursor()</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Execute the SQL query to fetch temperature data</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    cursor.execute(<span class="ss">f"SELECT s.Country, t.Year, t.Month, t.Temp </span><span class="ch">\</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a><span class="ss">                     FROM temperatures t JOIN stations s ON s.ID = t.ID </span><span class="ch">\</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a><span class="ss">                     WHERE s.Country = '</span><span class="sc">{</span>country<span class="sc">}</span><span class="ss">' AND t.Year &gt;= </span><span class="sc">{</span>year_begin<span class="sc">}</span><span class="ss"> AND t.Year &lt;= </span><span class="sc">{</span>year_end<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert the fetched data to a pandas DataFrame</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    result_df <span class="op">=</span> pd.DataFrame(cursor.fetchall(), columns<span class="op">=</span>[<span class="st">'Country'</span>, <span class="st">'Year'</span>, <span class="st">'Month'</span>, <span class="st">'Temp'</span>])</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Close the database connection</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    conn.close()</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then similarly, we will create a user-friendly function called <code>temp_trend_lineplot</code> to help us with the plotting. The function is supposed to takes in <code>country</code>, <code>year_begin</code>, and <code>year_end</code> as in the previous part, and returns a line plot show the monthly and yearly change in average temperature.</p>
<p>But beside the baseline, we can have some addition to the interactive plot. We will create two seperate figures for monthly and yearly average temperature, and adds bottons to control the displayed time period.</p>
<p>In the actual inplementation, we need to process the data using <code>groupby()</code> to get the average for a specific time period and <code>to_datetime</code> function to convert the time into <code>datetime</code> object for plotting.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:8,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018190345,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotly.subplots <span class="im">import</span> make_subplots</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> temp_trend_lineplot(country, year_begin<span class="op">=</span><span class="dv">1901</span>, year_end<span class="op">=</span><span class="dv">2020</span>):</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate a time series line plot showing the monthly and yearly average temperature for a specified country.</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co">    - country (str): The name of the country for which the plot is to be generated.</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co">    - year_begin (int, optional): The starting year for the data range. Default is 1901.</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co">    - year_end (int, optional): The ending year for the data range. Default is 2020.</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co">    - A Plotly figure object representing the time series line plot.</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Example:</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; fig = temp_trend_lineplot('India')</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Generates a line plot for India showing monthly and yearly average temperatures.</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fetch average temperature data for the specified country and year range</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    result_df <span class="op">=</span> query_avg_temp_by_country(country, year_begin, year_end)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate monthly average temperatures</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    avgs_df <span class="op">=</span> result_df.groupby([<span class="st">'Year'</span>, <span class="st">'Month'</span>])[<span class="st">'Temp'</span>].mean().reset_index()</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    avgs_df[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(avgs_df[<span class="st">'Year'</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'-'</span> <span class="op">+</span> avgs_df[<span class="st">'Month'</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'-01'</span>)</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate yearly average temperatures</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    yearly_avg <span class="op">=</span> avgs_df.resample(<span class="st">'Y'</span>, on<span class="op">=</span><span class="st">'Date'</span>).mean()</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create subplots for both monthly and yearly averages</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> make_subplots(rows<span class="op">=</span><span class="dv">2</span>, cols<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>                        shared_xaxes<span class="op">=</span><span class="va">True</span>, vertical_spacing<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>                        subplot_titles<span class="op">=</span>(<span class="st">'Monthly Average'</span>, <span class="st">'Yearly Average'</span>))</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add trace for monthly average temperatures</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>    fig.add_trace(</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>        go.Scatter(x<span class="op">=</span>avgs_df.Date, y<span class="op">=</span>avgs_df.Temp, name<span class="op">=</span><span class="st">'Monthly Average'</span>),</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>        row<span class="op">=</span><span class="dv">1</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add trace for yearly average temperatures</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>    fig.add_trace(</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>        go.Scatter(x<span class="op">=</span>yearly_avg.index, y<span class="op">=</span>yearly_avg.Temp, name<span class="op">=</span><span class="st">'Yearly Average'</span>),</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>        row<span class="op">=</span><span class="dv">2</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set the title and layout properties for the plot</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>    fig.update_layout(</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>        title_text<span class="op">=</span><span class="ss">f"Time series average temperature in </span><span class="sc">{</span>country<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>        height<span class="op">=</span><span class="dv">800</span></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add a range slider for date selection</span></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>    fig.update_layout(</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>        xaxis<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>            rangeselector<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>                buttons<span class="op">=</span><span class="bu">list</span>([</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">dict</span>(count<span class="op">=</span><span class="dv">6</span>,</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>                         label<span class="op">=</span><span class="st">"6m"</span>,</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>                         step<span class="op">=</span><span class="st">"month"</span>,</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>                         stepmode<span class="op">=</span><span class="st">"backward"</span>),</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">dict</span>(count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>                         label<span class="op">=</span><span class="st">"1y"</span>,</span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>                         step<span class="op">=</span><span class="st">"year"</span>,</span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>                         stepmode<span class="op">=</span><span class="st">"backward"</span>),</span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">dict</span>(count<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>                         label<span class="op">=</span><span class="st">"5y"</span>,</span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>                         step<span class="op">=</span><span class="st">"year"</span>,</span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>                         stepmode<span class="op">=</span><span class="st">"backward"</span>),</span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">dict</span>(step<span class="op">=</span><span class="st">"all"</span>)</span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>                ])</span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>            rangeslider<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a>                visible<span class="op">=</span><span class="va">False</span></span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>            <span class="bu">type</span><span class="op">=</span><span class="st">"date"</span></span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:26567,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018216904,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-outputid="767f5765-2434-4622-9156-19f00259d0a3" data-execution_count="21">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage: Generate and display the plot for India</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> temp_trend_lineplot(<span class="st">'India'</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="100%" height="820" src="iframe_figures/figure_21.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
<p>It seems that the seasonal temperature change are pretty regular in the long term, but in general, the yearly average temperature plot suggests that the temperature in India keeps getting warm from 1901 to recent years, though with some fluctuations.</p>
<p>See an another example.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:29804,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018246705,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-outputid="f8bcaaf3-daf6-4111-bf2b-3a5a8ae6ad4d" data-execution_count="22">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> temp_trend_lineplot(<span class="st">'United States'</span>, year_begin <span class="op">=</span> <span class="dv">2000</span>, year_end <span class="op">=</span> <span class="dv">2020</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="100%" height="820" src="iframe_figures/figure_22.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
<p>The seasonal pattern is also clear in the US, but it fluctuates at a much lower level compared with India, from around 0 to 25, while Indiaâ€™s temperature varies from around 16 to 30.</p>
</section>
<section id="visualization-3-stacked-histogram-with-box-plot-for-temperature-distribution" class="level3">
<h3 class="anchored" data-anchor-id="visualization-3-stacked-histogram-with-box-plot-for-temperature-distribution">Visualization 3: Stacked Histogram With Box Plot for Temperature Distribution</h3>
<p>In this section, we want to answer the question: <strong><em>how does the distribution of temperature differ between different countries</em></strong>?</p>
<p>As usual, the first task is to create a query function to retrieve the data. We will create a function called <code>query_temp_by_country</code> that takes four parameters, one required list-type argument <code>countries</code>, and three optional arguments: <code>month</code>,<code>year_begin</code>, <code>year_end</code>. If <code>month</code> is not specified, then it will return all temperature data within the time period. The return would be a DataFrame containing temperature data for the specified countries, month, and year range.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:6,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018246707,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> query_temp_by_country(countries, month<span class="op">=</span><span class="dv">0</span>, year_begin<span class="op">=</span><span class="dv">1901</span>, year_end<span class="op">=</span><span class="dv">2020</span>):</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Fetch temperature data for specified countries from an SQLite database.</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">    This function queries temperature data based on a list of countries, a specified month,</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co">    and a year range from the database. The data is returned as a pandas DataFrame.</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co">    - countries (list of str): A list of country names for which data is to be fetched.</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co">    - month (int, optional): The month for which data is to be fetched. Default is 0, which fetches data for all months.</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co">    - year_begin (int, optional): The starting year for the data range. Default is 1901.</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="co">    - year_end (int, optional): The ending year for the data range. Default is 2020.</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="co">    - pd.DataFrame: A DataFrame containing temperature data for the specified countries, month, and year range.</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Example:</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; query_temp_by_country(['Zimbabwe', 'USA'], month=1, year_begin=2000, year_end=2010)</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns a DataFrame with temperature data for Zimbabwe and USA for the month of January between the years 2000 and 2010.</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    conn <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">"temps.db"</span>)</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    cursor <span class="op">=</span> conn.cursor()</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a placeholder for each country in the list</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    placeholders <span class="op">=</span> <span class="st">', '</span>.join([<span class="st">'?'</span>] <span class="op">*</span> <span class="bu">len</span>(countries))</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Using parameterized query for different input length</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    query_str <span class="op">=</span> <span class="ss">f"""SELECT t.Year, t.Temp, s.Country, t.Month</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="ss">                    FROM temperatures t JOIN stations s</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a><span class="ss">                    ON s.ID = t.ID</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a><span class="ss">                    WHERE s.Country IN (</span><span class="sc">{</span>placeholders<span class="sc">}</span><span class="ss">) AND t.Year &gt;= ? AND t.Year &lt;= ?"""</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List of parameters for the query</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> countries <span class="op">+</span> [year_begin, year_end]</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add restrictions to month depending on the input</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> month <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>        query_str <span class="op">+=</span> <span class="st">' AND t.Month = ?'</span></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>        params.append(month)</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Query and get results</span></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>    cursor.execute(query_str, params)</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>    result_df <span class="op">=</span> pd.DataFrame(cursor.fetchall(), columns<span class="op">=</span>[<span class="st">'Year'</span>, <span class="st">'Temp'</span>, <span class="st">'Country'</span>, <span class="st">'Month'</span>])</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>    conn.close()</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With the query function, we can start working on the actual plotting function. We will create a function named <code>stacked_histogram</code> that takes in the same arguments as <code>query_temp_by_country</code>. Since the input is a bit different as previous functions, we hope to remind the user of the data type. In Python <code>Raises...TypeError</code> allows us to do this.</p>
<p>As return, we hope to get a stacked histogram for a list of countries, with their box plots, where the y axis suggest the number of observations, and x axis specifies temperature bins.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:7,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018246709,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> stacked_histogram(countries, month<span class="op">=</span><span class="dv">0</span>, year_begin<span class="op">=</span><span class="dv">1901</span>, year_end<span class="op">=</span><span class="dv">2020</span>):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Create a stacked histogram of temperature data for specified countries.</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co">    This function fetches temperature data based on a list of countries, a specified month,</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co">    and a year range using the `query_temp_by_country` function. It then creates a stacked histogram</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co">    using Plotly Express and returns the figure.</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co">    - countries (list of str): A list of country names for which the histogram is to be created.</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co">    - month (int, optional): The month for which the histogram is to be created. Default is 0, which uses data for all months.</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="co">    - year_begin (int, optional): The starting year for the data range. Default is 1901.</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co">    - year_end (int, optional): The ending year for the data range. Default is 2020.</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="co">    - A Plotly figure object representing the stacked histogram.</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Example:</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; fig = stacked_histogram(['Zimbabwe', 'United States'], month=1, year_begin=2000, year_end=2010)</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Creates and returns a stacked histogram for Zimbabwe and USA for the month of January between the years 2000 and 2010.</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">type</span>(countries) <span class="op">!=</span> <span class="bu">list</span>:</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">TypeError</span>(<span class="st">'Countries must be a list.'</span>)</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># retrieve data from database</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    result_df <span class="op">=</span> query_temp_by_country(countries, month, year_begin, year_end)</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot a stacked histogram</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> px.histogram(result_df, x<span class="op">=</span><span class="st">"Temp"</span>, color<span class="op">=</span><span class="st">"Country"</span>, marginal<span class="op">=</span><span class="st">'box'</span>)</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add a title</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>    title_text <span class="op">=</span> <span class="ss">f"Stacked histogram of historical termperature distribution between </span><span class="sc">{</span>year_begin<span class="sc">}</span><span class="ss"> and </span><span class="sc">{</span>year_end<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> month<span class="op">&gt;</span><span class="dv">0</span>:</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>            title_text <span class="op">+=</span> <span class="ss">f" in </span><span class="sc">{</span>month_mapping[month]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set the title</span></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>    fig.update_layout(</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>        title_text<span class="op">=</span>title_text</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:13260,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018259963,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-outputid="8d66ba3a-56e9-4348-8f55-ee75a5ea35bf" data-execution_count="25">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's try an extreme cases.</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>stacked_histogram([<span class="st">'Zimbabwe'</span>,<span class="st">'Netherlands'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="100%" height="545px" src="iframe_figures/figure_25.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
<p>We can tell that the two countries have different climate patterns since their interquartile range did not overlap. Also, the height of the stacked chart suggest probably these two countries have similar numbers of stations.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:3777,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1698018263716,&quot;user&quot;:{&quot;displayName&quot;:&quot;HAORAN JIA&quot;,&quot;userId&quot;:&quot;00526075531643448393&quot;},&quot;user_tz&quot;:420}" data-outputid="96153445-b3d5-4d68-b068-e2f8e98204c7" data-execution_count="26">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># One more example</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>stacked_histogram([<span class="st">'Argentina'</span>, <span class="st">'China'</span>,<span class="st">'Canada'</span>], month <span class="op">=</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="100%" height="545px" src="iframe_figures/figure_26.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
<p>From this graph, we can tell that Canada have many extreme values below 0, as the outliers. China has the longest interquartile range, suggesting a larger variation in climate patterns within the country.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>